<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>ğŸ¦™ LAMA ADVENTURE : RPG FINAL</title>
<style>
:root{
  --bg:#2c3e50; --wall:#34495e; --player:#3498db;
  --enemy:#e74c3c; --boss:#c0392b; --exit:#2ecc71; --boost:#f1c40f;
}
body{margin:0;font-family:sans-serif;background:var(--bg);color:white;display:flex;flex-direction:column;align-items:center;}
canvas{border:4px solid var(--wall);border-radius:8px;margin:5px;max-width:98vw;}
#ui{display:flex;flex-direction:column;align-items:center;gap:5px;width:100%;}
.stats-row{display:flex;gap:8px;justify-content:center;flex-wrap:wrap;}
.stat{background:rgba(0,0,0,0.3);padding:5px 12px;border-radius:15px;font-size:0.8rem;}
.overlay{
  position:fixed; inset:0; background:rgba(0,0,0,0.95); display:none;
  flex-direction:column; justify-content:center; align-items:center;
  z-index:10; text-align:center; padding:15px; box-sizing:border-box;
}
.restart{padding:15px 40px;font-size:1.2rem;background:#2ecc71;border:none;color:white;border-radius:30px;margin-top:20px;font-weight:bold;cursor:pointer;}
#joystick{position:fixed;bottom:20px;left:20px;width:120px;height:120px;border-radius:50%;background:rgba(255,255,255,0.2);touch-action:none;display:flex;justify-content:center;align-items:center;}
#stick{width:60px;height:60px;border-radius:50%;background:rgba(255,255,255,0.5);}
.shopItem{background:#34495e;margin:5px;padding:8px 15px;border-radius:10px;cursor:pointer;}
.rankItem{margin:3px 0;background:#34495e;padding:5px 10px;border-radius:10px;width:200px;text-align:left;}
button,input{padding:10px;border:none;border-radius:16px;font-size:14px;margin:4px}
</style>
</head>
<body>

<!-- ë¡œê·¸ì¸ í™”ë©´ -->
<div id="loginScreen" class="overlay">
<h1>ğŸ¦™ ë¡œê·¸ì¸ / íšŒì›ê°€ì…</h1>
<input id="nickInput" placeholder="ë‹‰ë„¤ì„(2~12ì)">
<input id="passInput" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸">
<div id="loginMsg" style="color:#f1c40f;margin:5px;"></div>
<button class="restart" onclick="login()">ë¡œê·¸ì¸ / ê°€ì…</button>
</div>

<!-- UI -->
<div id="ui">
  <div class="stats-row">
    <div class="stat">ğŸ”‘ <span id="keys">0</span></div>
    <div class="stat">â¤ï¸ <span id="lives">0</span></div>
    <div class="stat">â± <span id="gameTimer">0.0</span>s</div>
    <div class="stat">ğŸ’° <span id="gold">0</span></div>
  </div>
  <div class="stats-row">
    <button onclick="openShop()">ğŸ›’ ìƒì </button>
    <button onclick="showRanking()">ğŸ† ë­í‚¹</button>
    <button onclick="logout()">ğŸ”„ ë¡œê·¸ì•„ì›ƒ</button>
  </div>
</div>

<!-- ê²Œì„ ìº”ë²„ìŠ¤ -->
<canvas id="gameCanvas"></canvas>

<!-- ì¡°ì´ìŠ¤í‹± -->
<div id="joystick">
  <div id="stick"></div>
</div>

<!-- ìƒì  -->
<div id="shopScreen" class="overlay">
<h1>ğŸª ì•„ì´í…œ ìƒì </h1>
<div class="shopItem" onclick="buyItem('hp')">ğŸ’– ì²´ë ¥ +1 (10ê³¨ë“œ)</div>
<div class="shopItem" onclick="buyItem('speed')">âš¡ ìŠ¤í”¼ë“œ +0.5 (15ê³¨ë“œ)</div>
<div class="restart" onclick="closeShop()">ë‹«ê¸°</div>
</div>

<!-- ë­í‚¹ -->
<div id="rankingScreen" class="overlay">
<h1>ğŸ† ë­í‚¹</h1>
<div id="rankingList"></div>
<button class="restart" onclick="closeRanking()">ë‹«ê¸°</button>
</div>

<!-- ê²Œì„ ì˜¤ë²„ / ìµœì¢… -->
<div id="finalScreen" class="overlay">
<h1 id="finalStatus">ğŸ‰ ê²Œì„ ì¢…ë£Œ</h1>
<p>ê¸°ë¡: <span id="finalTimeDisplay">0</span>ì´ˆ</p>
<p>íšë“ ê³¨ë“œ: <span id="finalGoldDisplay">0</span></p>
<button class="restart" onclick="showRanking()">ë­í‚¹ í™•ì¸</button>
<button class="restart" onclick="location.reload()">ì²˜ìŒìœ¼ë¡œ</button>
</div>

<script>
// =================== DATA ===================
let users=JSON.parse(localStorage.getItem("lama_users")||"{}");
let currentUser=localStorage.getItem("lama_current")||"";
const canvas=document.getElementById('gameCanvas');
const ctx=canvas.getContext('2d');
let tileSize=24, cols=25, rows=25;
let player={x:1,y:1,keys:0,lives:3,speed:1,color:0,skills:[],gold:0};
let maze=[], enemies=[], boss=null, isRunning=false, startTime=0, totalTime=0;
let joystick={x:0,y:0,active:false};
const stick=document.getElementById('stick');
const joyBase=document.getElementById('joystick');
const COLORS=["#0fbcf9","#00cec9","#6c5ce7","#e84393","#fdcb6e","#00b894","#0984e3","#d63031","#e17055","#2d3436"];

// =================== LOGIN ===================
function login(){
  const nick = nickInput.value.trim();
  const pass = passInput.value;
  const msg = loginMsg;
  if(!nick || !pass){ msg.innerText="ë‹‰ë„¤ì„ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”"; return; }
  if(nick.length<2||nick.length>12){ msg.innerText="ë‹‰ë„¤ì„ 2~12ì"; return; }
  if(users[nick]){
    if(users[nick].password!==btoa(pass)){ msg.innerText="ë¹„ë°€ë²ˆí˜¸ í‹€ë¦¼"; return; }
  } else {
    users[nick]={password:btoa(pass),gold:20,bestTime:0,color:0,items:{hp:0,speed:0},skills:[]};
  }
  currentUser=nick;
  localStorage.setItem("lama_users",JSON.stringify(users));
  localStorage.setItem("lama_current",nick);
  loginScreen.style.display="none";
  initGameAfterLogin();
}
function logout(){ save(); location.reload(); }

// =================== INIT GAME ===================
function initGameAfterLogin(){
  const u=users[currentUser];
  player={...player,...u};
  startTime=Date.now();
  generateMaze(rows);
  tileSize=Math.floor(Math.min(window.innerWidth,window.innerHeight)*0.035);
  canvas.width=tileSize*cols; canvas.height=tileSize*rows;
  document.getElementById('lives').innerText=player.lives;
  document.getElementById('gold').innerText=player.gold;
  document.getElementById('keys').innerText=player.keys;
  isRunning=true;
  requestAnimationFrame(gameLoop);
}

// =================== MAZE / ENEMY ===================
function generateMaze(size){
  maze=Array.from({length:size},()=>Array(size).fill(1));
  function carve(x,y){
    maze[y][x]=0;
    const dirs=[[0,2],[0,-2],[2,0],[-2,0]].sort(()=>Math.random()-0.5);
    for(const [dx,dy] of dirs){
      let nx=x+dx, ny=y+dy;
      if(nx>0&&nx<size-1&&ny>0&&ny<size-1&&maze[ny][nx]===1){
        maze[y+dy/2|0][x+dx/2|0]=0; carve(nx,ny);
      }
    }
  }
  carve(1,1);
  placeItems(); placeEnemies();
}
function placeItems(){
  let keysCount=5,p=0;
  while(p<keysCount){
    let rx=Math.floor(Math.random()*cols), ry=Math.floor(Math.random()*rows);
    if(maze[ry][rx]===0&&!((rx===1&&ry===1))){ maze[ry][rx]=2; p++; }
  }
}
function placeEnemies(){
  enemies=[];
  let eCount=5;
  while(eCount>0){
    let rx=Math.floor(Math.random()*cols), ry=Math.floor(Math.random()*rows);
    if(maze[ry][rx]===0&&!((rx===1&&ry===1))){
      enemies.push({x:rx,y:ry,hp:1}); eCount--;
    }
  }
}

// =================== GAME LOOP ===================
function gameLoop(){
  if(!isRunning) return;
  totalTime=((Date.now()-startTime)/1000).toFixed(1);
  document.getElementById('gameTimer').innerText=totalTime;
  handleJoystick();
  updateEnemies();
  draw();
  requestAnimationFrame(gameLoop);
}
function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  for(let y=0;y<rows;y++) for(let x=0;x<cols;x++){
    ctx.fillStyle=maze[y][x]===1?varColor('--wall'):'#ecf0f1';
    ctx.fillRect(x*tileSize,y*tileSize,tileSize,tileSize);
    if(maze[y][x]===2){
      ctx.fillStyle='gold'; ctx.beginPath();
      ctx.arc(x*tileSize+tileSize/2,y*tileSize+tileSize/2,tileSize/4,0,Math.PI*2); ctx.fill();
    }
  }
  ctx.fillStyle=COLORS[player.color];
  ctx.beginPath();
  ctx.arc(player.x*tileSize+tileSize/2,player.y*tileSize+tileSize/2,tileSize/3,0,Math.PI*2); ctx.fill();
  ctx.fillStyle=varColor('--enemy');
  enemies.forEach(e=>ctx.fillRect(e.x*tileSize+tileSize/4,e.y*tileSize+tileSize/4,tileSize/2,tileSize/2));
}
function varColor(name){return getComputedStyle(document.documentElement).getPropertyValue(name);}

// =================== MOVEMENT ===================
function move(dx,dy){
  if(!isRunning) return;
  let nx=player.x+dx, ny=player.y+dy;
  if(nx>=0&&nx<cols&&ny>=0&&ny<rows&&maze[ny][nx]!==1){ player.x=nx; player.y=ny; checkTile(); draw(); }
}
function handleJoystick(){
  if(!joystick.active) return;
  let dx=joystick.x, dy=joystick.y;
  if(Math.abs(dx)>Math.abs(dy)){ move(dx>0?1:-1,0); } else { move(0,dy>0?1:-1); }
}
function checkTile(){
  if(maze[player.y][player.x]===2){ player.keys++; maze[player.y][player.x]=0; document.getElementById('keys').innerText=player.keys; }
}
window.addEventListener('keydown',e=>{
  if(e.key.includes('Arrow')) move(e.key.replace('Arrow','').toLowerCase()==='up'?0:-1,0);
});

// =================== JOYSTICK ===================
joyBase.addEventListener('pointerdown',e=>{ joystick.active=true; joystick.startX=e.clientX; joystick.startY=e.clientY; joystick.x=0; joystick.y=0; });
joyBase.addEventListener('pointermove',e=>{ if(!joystick.active) return; joystick.x=e.clientX-joystick.startX; joystick.y=e.clientY-joystick.startY; stick.style.transform=`translate(${joystick.x/2}px,${joystick.y/2}px)`; });
joyBase.addEventListener('pointerup',e=>{ joystick.active=false; joystick.x=0; joystick.y=0; stick.style.transform='translate(0px,0px)'; });

// =================== ENEMY ===================
function updateEnemies(){
  enemies.forEach(e=>{
    let dx=player.x-e.x, dy=player.y-e.y;
    if(Math.abs(dx)>Math.abs(dy)) e.x+=Math.sign(dx); else e.y+=Math.sign(dy);
    if(e.x===player.x&&e.y===player.y) hitPlayer();
  });
}
function hitPlayer(){ player.lives--; document.getElementById('lives').innerText=player.lives; if(player.lives<=0) gameOver(); }

// =================== SHOP ===================
function openShop(){ shopScreen.style.display='flex'; }
function closeShop(){ shopScreen.style.display='none'; }
function buyItem(type){
  let cost = type==='hp'?10:15;
  if(player.gold<cost) return alert('ê³¨ë“œ ë¶€ì¡±');
  player.gold-=cost;
  if(type==='hp') player.lives++; else if(type==='speed') player.speed+=0.5;
  document.getElementById('gold').innerText = player.gold;
}

// =================== RANK ===================
function showRanking(){
  rankingScreen.style.display='flex';
  const list=Object.entries(users).sort((a,b)=>a[1].bestTime-b[1].bestTime);
  rankingList.innerHTML='';
  list.forEach(([nick,data],i)=>{ rankingList.innerHTML+=`<div class="rankItem">${i+1}. ${nick} - ${data.bestTime.toFixed(1)}s</div>`; });
}
function closeRanking(){ rankingScreen.style.display='none'; }

// =================== SAVE ===================
function save(){
  users[currentUser].bestTime=Math.max(users[currentUser].bestTime, parseFloat(totalTime));
  users[currentUser].gold=player.gold;
  localStorage.setItem('lama_users',JSON.stringify(users));
}

// =================== GAME OVER ===================
function gameOver(){
  isRunning=false;
  finalStatus.innerText='ğŸ’€ GAME OVER';
  finalScreen.style.display='flex';
  save();
}
</script>
</body>
</html>